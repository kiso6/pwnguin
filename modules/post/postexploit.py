import subprocess
import random as rng

def openCtrlSrv(bindaddr="0.0.0.0"):
    """ Open control and command server with random ports"""
    port = rng.randint(5000, 65535)
    cmd = "python3 -m http.server -d . -b " + bindaddr+" "+str(port)+"&> /dev/null"
    print(cmd)
    proc = subprocess.run(cmd,shell=True)
    if proc:
        print("Opened control server @ " + bindaddr+":"+str(port))
        return (proc,port)
    else:
        print("Failed to open control server")
        exit(-500)

def scanNetwork(IP="192.168.1.0/24",
                mask8=False,
                mask16=False,
                mask24=True)-> list:
    """ Scan networks looking for hosts """
    mask = int((IP.split(".")[-1]).split("/")[-1])
    if (mask8 == False) & (mask == 8):
        print("Mask /8 Not scanned (Skipped by user).")
        return []
    elif (mask16 == False) & (mask == 16):
        print("Mask /16 Not scanned (Skipped by user).")
        return []
    elif (mask24 == False) & (mask == 24):
        print("Mask /24 Not scanned (Skipped by user).")
        return []
    else:
        command = "nmap -sn " +IP+" | grep " +" 'Nmap scan report' "+ "| awk '{print $6}' | sed 's/.//;s/.$//' > hosts"
        proc = subprocess.run(command, shell=True)
        if proc:
            hosts = []
            with open("./hosts","r+") as f:
                hosts = f.readlines()
            res = [h.strip("\n") for h in hosts]
    return res

def getTargetConnections()-> list:
    """Gather all IP adresses on current host """
    command = "ip -o -4 addr | grep '/' |awk '{print $4}' > ips"
    proc = subprocess.run(command, shell=True)
    if proc: 
        ips = []
        with open("./ips","r+") as f:
            ips = f.readlines()
        res = [ip.strip("\n") for ip in ips]
    return res

def machine_to_rzo(ip_list=[])->list:
    """Utile tkt"""
    if (len(ip_list) == 0):
        print("No ip in list.")
        return []
    res = []
    for addr in ip_list:
        mask = (addr.split(".")[-1]).split("/")[-1]
        adr = (addr.split("."))[0:3]
        end = (addr.split(".")[-1]).split("/")[0]
        adr.append(end)
        adr[0] = adr[0]+"."
        if int(mask) == 8:
            adr[1] = '0.'
            adr[2] = '0.'
            adr[3] = '0'
        elif int(mask) == 16:
            adr[1] = adr[1]+"."
            adr[2] = '0.'
            adr[3] = '0'
        elif int(mask) == 24:
            adr[1] = adr[1]+"."
            adr[2] = adr[2]+"."
            adr[3] = '0'
        adr.append("/"+mask)
        res.append(adr)
    ret = []
    for r in res:
        ret.append(''.join(r))
    return ret


# tab = machine_to_rzo(getTargetConnections())

# for ip in tab:
#     print(ip)
#     print(scanNetwork(ip))

# print(scanNetwork()
# (serv,port) =  openCtrlSrv("192.168.1.86")