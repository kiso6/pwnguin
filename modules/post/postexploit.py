import re
import subprocess
import random as rng


def openCtrlSrv(bindaddr="0.0.0.0"):
    """Open control and command server with random ports"""
    port = rng.randint(5000, 65535)
    cmd = (
        "python3 -m http.server -d . -b " + bindaddr + " " + str(port) + "&> /dev/null"
    )
    print(cmd)
    proc = subprocess.run(cmd, shell=True)
    if proc:
        print("Opened control server @ " + bindaddr + ":" + str(port))
        return (proc, port)
    else:
        print("Failed to open control server")
        exit(-500)


def scanNetwork(IP="192.168.1.0/24", minMask=16) -> list:
    """Scan networks looking for hosts"""
    mask = int((IP.split(".")[-1]).split("/")[-1])
    if mask < minMask:
        print("Too many adresses to scan. Not scanned (Skipped by user).")
        return []
    else:
        command = f"nmap -sn {IP}"
        proc = subprocess.run(command, shell=True, stdout=subprocess.PIPE)
        if proc:
            output = proc.stdout.decode("utf-8")
            return re.findall(r"(?:[0-9]{1,3}\.){3}[0-9]{1,3}", output)


def getTargetConnections() -> list:
    """Gather IPs from all interfaces"""
    command = "ip -o -4 addr | grep '/' | awk '{print $2, $4}'"
    proc = subprocess.run(command, shell=True, stdout=subprocess.PIPE)
    if proc:
        networks = proc.stdout.decode("utf-8").strip("\n").split("\n")
        return [network.split(" ") for network in networks]


def getKnownARP() -> list:
    """Gather IPs/MACs from ARP table"""
    command = "cat /proc/net/arp| grep -v '0x0' | tail -n +2 | awk '{print $1, $4, $6}'"
    proc = subprocess.run(command, shell=True, stdout=subprocess.PIPE)
    if proc:
        lines = proc.stdout.decode("utf-8").strip("\n").split("\n")
        res = []
        for line in lines:
            x = line.split(" ")
            res.append({"ip": x[0][1:-1], "mac": x[1], "iface": x[2]})
    return res


def machine_to_rzo(ip_list=[]) -> list:
    """Utile tkt"""
    if len(ip_list) == 0:
        print("No ip in list.")
        return []
    res = []
    for addr in ip_list:
        mask = (addr.split(".")[-1]).split("/")[-1]
        adr = (addr.split("."))[0:3]
        end = (addr.split(".")[-1]).split("/")[0]
        adr.append(end)
        adr[0] = adr[0] + "."
        if int(mask) == 8:
            adr[1] = "0."
            adr[2] = "0."
            adr[3] = "0"
        elif int(mask) == 16:
            adr[1] = adr[1] + "."
            adr[2] = "0."
            adr[3] = "0"
        elif int(mask) == 24:
            adr[1] = adr[1] + "."
            adr[2] = adr[2] + "."
            adr[3] = "0"
        adr.append("/" + mask)
        res.append(adr)
    ret = []
    for r in res:
        ret.append("".join(r))
    return ret


def getOS() -> str:
    """Get OS name, version and architecture"""
    command = "cat /etc/os-release | grep '^PRETTY_NAME' | cut -d= -f2- | tr -d '\"'; cat /etc/os-release | grep '^VERSION_CODENAME' | cut -d= -f2- | tr -d '\"'; uname -m"
    proc = subprocess.run(command, shell=True, stdout=subprocess.PIPE)
    if proc:
        infos = proc.stdout.decode("utf-8").strip("\n").split("\n")
        return " ".join(infos)


# tab = machine_to_rzo(getTargetConnections())

# for ip in tab:
#     print(ip)
#     print(scanNetwork(ip))

# print(scanNetwork()
# (serv,port) =  openCtrlSrv("192.168.1.86")
