import subprocess
import random as rng

def openCtrlSrv(bindaddr="0.0.0.0"):
    """ Open control and command server with random ports"""
    port = rng.randint(5000, 65535)
    cmd = "python3 -m http.server -d . -b " + bindaddr+" "+str(port)+"&> /dev/null"
    print(cmd)
    proc = subprocess.run(cmd,shell=True)
    if proc:
        print("Opened control server @ " + bindaddr+":"+str(port))
        return (proc,port)
    else:
        print("Failed to open control server")
        exit(-500)

def scanNetwork(IP="192.168.1.0/24"):
    """ Scan networks looking for hosts """
    command = "nmap -sn " +IP+" | grep " +" 'Nmap scan report' "+ "| awk '{print $6}' | sed 's/.//;s/.$//' > hosts"
    proc = subprocess.run(command, shell=True)
    if proc:
        hosts = []
        with open("./hosts","r+") as f:
            hosts = f.readlines()
        res = [h.strip("\n") for h in hosts]
    return res

def getTargetConnections():
    """Gather all IP adresses on current host """
    command = "ip -o -4 addr | awk '{print $4}' > ips"
    proc = subprocess.run(command, shell=True)
    if proc: 
        ips = []
        with open("./ips","r+") as f:
            ips = f.readlines()
        res = [ip.strip("\n") for ip in ips]
    return res

# print(getTargetConnections())
# print(scanNetwork()
# (serv,port) =  openCtrlSrv("192.168.1.86")